<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ResearchR</title>
  <style>
    :root {
      --bg: #0c1021;
      --panel: #11162b;
      --accent: #6be6ff;
      --text: #e8f0ff;
      --muted: #9fb3d1;
      --danger: #ff9f80;
      --success: #7ce0a3;
    }
    * { box-sizing: border-box; }
    html, body {
      height: 100%;
    }
    body {
      margin: 0;
      font-family: "Segoe UI", system-ui, sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(107,230,255,0.1), transparent 25%), radial-gradient(circle at 80% 0%, rgba(124,224,163,0.15), transparent 20%), var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      overflow: hidden;
    }
    .container {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 12px;
      width: 100%;
      padding: 16px;
      height: 100vh;
      overflow: hidden;
    }
    @media (max-width: 900px) {
      .container {
        grid-template-columns: 1fr;
      }
    }
    .panel {
      background: var(--panel);
      border: 1px solid rgba(255,255,255,0.05);
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      min-height: 0;
    }
    .chat-window {
      display: flex;
      flex-direction: column;
      height: 85vh;
    }
    .messages {
      flex: 1;
      overflow-y: auto;
      padding-right: 8px;
    }
    .sidebar {
      height: 85vh;
      overflow-y: auto;
    }
    .message {
      margin-bottom: 14px;
      padding: 12px;
      border-radius: 12px;
      line-height: 1.5;
    }
    .message.user {
      background: rgba(107,230,255,0.08);
      border: 1px solid rgba(107,230,255,0.25);
      align-self: flex-end;
    }
    .message.assistant {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.05);
    }
    .input-row {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    textarea {
      flex: 1;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.1);
      background: #0a0f1f;
      color: var(--text);
      resize: vertical;
      min-height: 60px;
    }
    button {
      background: linear-gradient(135deg, var(--accent), #53b8f7);
      color: #0c1021;
      border: none;
      padding: 0 18px;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.1s ease;
    }
    button:active { transform: translateY(1px); box-shadow: inset 0 2px 4px rgba(0,0,0,0.3); }
    h2 { margin-top: 0; letter-spacing: 0.4px; }
    .sidebar-section { margin-bottom: 18px; }
    .hit { padding: 10px; border-radius: 10px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); margin-bottom: 10px; }
    .hit a { color: var(--accent); text-decoration: none; font-weight: 700; }
    .muted { color: var(--muted); font-size: 13px; }
    .badge { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; background: rgba(107,230,255,0.12); color: var(--accent); border: 1px solid rgba(107,230,255,0.4); }
    .assumption { border-left: 3px solid var(--accent); padding-left: 10px; margin-bottom: 8px; }
    .warning { border-left: 3px solid var(--danger); padding-left: 10px; margin-bottom: 8px; }
    .status { font-size: 13px; color: var(--muted); height: 20px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="panel chat-window">
      <div class="messages" id="messages"></div>
      <div class="status" id="status"></div>
      <div class="input-row">
        <textarea id="input" placeholder="Paste an equation or ask a technical question..."></textarea>
        <button id="send">Send</button>
      </div>
    </div>
    <div class="panel sidebar">
      <div class="sidebar-section">
        <h2>Equation matches</h2>
        <div id="equation-hits" class="muted">None yet.</div>
      </div>
      <div class="sidebar-section">
        <h2>Current assumptions</h2>
        <div id="assumptions" class="muted">None yet.</div>
      </div>
      <div class="sidebar-section">
        <h2>Consistency warnings</h2>
        <div id="warnings" class="muted">None yet.</div>
      </div>
    </div>
  </div>

  <script>
    const messagesEl = document.getElementById("messages");
    const inputEl = document.getElementById("input");
    const sendBtn = document.getElementById("send");
    const statusEl = document.getElementById("status");
    const hitsEl = document.getElementById("equation-hits");
    const assumptionsEl = document.getElementById("assumptions");
    const warningsEl = document.getElementById("warnings");

    const sessionId = localStorage.getItem("researchr_session") || crypto.randomUUID();
    localStorage.setItem("researchr_session", sessionId);

    const messages = [];

    function addMessage(role, text) {
      messages.push({ role, text });
      const div = document.createElement("div");
      div.className = `message ${role}`;
      div.innerHTML = `<strong>${role === "user" ? "You" : "ResearchR"}</strong><br>${text}`;
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function renderAssumptions(list) {
      if (!list || list.length === 0) {
        assumptionsEl.textContent = "None yet.";
        return;
      }
      assumptionsEl.innerHTML = "";
      list.forEach((a) => {
        const div = document.createElement("div");
        div.className = "assumption";
        div.innerHTML = `<div>${a.text}</div><div class="muted">${a.type || "assumption"} • turn ${a.created_at_turn}</div>`;
        assumptionsEl.appendChild(div);
      });
    }

    function renderHits(hits) {
      if (!hits || hits.length === 0) {
        hitsEl.textContent = "No equation matches yet.";
        return;
      }
      hitsEl.innerHTML = "";
      hits.forEach((h) => {
        const div = document.createElement("div");
        div.className = "hit";
        div.innerHTML = `
          <a href="${h.url}" target="_blank" rel="noopener">${h.title || "Source"}</a>
          <div class="muted">${h.authors || ""} ${h.year ? "• " + h.year : ""}</div>
          <div>${h.context_snippet || ""}</div>
          <div class="badge">${h.relation_to_query_equation || "related"}</div>
        `;
        hitsEl.appendChild(div);
      });
    }

    function renderWarnings(warnings) {
      if (!warnings || warnings.length === 0) {
        warningsEl.textContent = "None.";
        return;
      }
      warningsEl.innerHTML = "";
      warnings.forEach((w) => {
        const div = document.createElement("div");
        div.className = "warning";
        div.innerHTML = `<div>${w.problem_type || "issue"}</div><div class="muted">${w.explanation || ""}</div>`;
        warningsEl.appendChild(div);
      });
    }

    async function sendMessage() {
      const text = inputEl.value.trim();
      if (!text) return;
      addMessage("user", text.replace(/\n/g, "<br>"));
      inputEl.value = "";
      statusEl.textContent = "Thinking…";

      try {
        const resp = await fetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ session_id: sessionId, message: text }),
        });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();
        addMessage("assistant", (data.assistant_message || "").replace(/\n/g, "<br>"));
        renderHits(data.equation_hits);
        renderAssumptions(data.assumptions);
        renderWarnings(data.consistency_warnings);
        statusEl.textContent = "";
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Error contacting server.";
      }
    }

    sendBtn.addEventListener("click", sendMessage);
    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && (e.metaKey || e.ctrlKey)) {
        e.preventDefault();
        sendMessage();
      }
    });
  </script>
</body>
</html>
